<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markov Chain Simulator</title>
    <link rel="icon" href="../favicon.ico">
    <style>
        :root {
            --bg-color: #0f172a;       /* Deep Navy */
            --card-bg: #1e293b;        /* Slate Blue */
            --text-color: #e2e8f0;     /* Off-white */
            --text-muted: #94a3b8;
            --accent: #38bdf8;         /* Cyan */
            --accent-glow: rgba(56, 189, 248, 0.5);
            --border: rgba(255,255,255,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        h1 { margin: 0 0 5px 0; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; color: white; }
        p.subtitle { margin-top: 0; margin-bottom: 30px; color: var(--text-muted); font-size: 0.9rem; }

        /* --- LAYOUT GRID --- */
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%; max-width: 1000px;
        }
        
        @media(min-width: 800px) {
            .layout-grid { grid-template-columns: 2fr 1fr; } /* Diagram Left, Stats Right */
        }

        /* --- THE DIAGRAM (Left Side) --- */
        .diagram-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            height: 400px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* SVG Arrows */
        .svg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        path {
            fill: none; 
            stroke: #475569; /* Dark Grey Lines */
            stroke-width: 2; 
            transition: stroke 0.3s;
        }
        path.active-path {
            stroke: var(--accent); 
            stroke-width: 3; 
            filter: drop-shadow(0 0 5px var(--accent));
            animation: dash 0.5s linear;
        }

        /* Circular Nodes */
        .state-node {
            position: absolute;
            width: 80px; height: 80px;
            background: #0f172a;
            border: 2px solid #475569;
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .state-node.active {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            transform: translate(-50%, -50%) scale(1.1);
            background: #1e293b;
        }

        .state-icon { font-size: 1.8rem; margin-bottom: 2px; }
        .state-label { font-size: 0.75rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; }
        .state-node.active .state-label { color: white; }

        /* --- STATS PANEL (Right Side) --- */
        .stats-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            display: flex; flex-direction: column;
            gap: 15px;
        }

        .main-status {
            text-align: center; margin-bottom: 10px;
            padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        .big-icon { font-size: 3rem; animation: bounce 1s infinite alternate; display: inline-block; }
        .step-count { font-family: monospace; color: var(--text-muted); font-size: 0.9rem; margin-top: 5px; }

        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        /* Bars */
        .bar-group { width: 100%; }
        .bar-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; }
        .track { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; position: relative; overflow: hidden; }
        .fill { height: 100%; border-radius: 4px; transition: width 0.2s; }
        
        /* The "Target" Marker */
        .marker {
            position: absolute; top: -2px; bottom: -2px; width: 2px; 
            background: white; z-index: 5; box-shadow: 0 0 5px white;
        }

        /* --- CONTROLS BAR (Bottom) --- */
        .controls-bar {
            position: fixed; bottom: 30px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid var(--border);
            display: flex; gap: 15px; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
        }

        select {
            background: transparent; color: white; border: none; font-weight: bold; cursor: pointer;
            padding-right: 10px; border-right: 1px solid var(--border);
        }
        select:focus { outline: none; }

        button {
            background: transparent; border: none; color: var(--text-muted); 
            cursor: pointer; padding: 8px 12px; border-radius: 8px; font-weight: 600;
            transition: all 0.2s;
        }
        button:hover { background: rgba(255,255,255,0.1); color: white; }
        
        button.primary {
            background: var(--accent); color: #0f172a; padding: 8px 20px; border-radius: 20px;
        }
        button.primary:hover { transform: scale(1.05); background: #7dd3fc; }

        /* Slider */
        .speed-control { display: flex; align-items: center; gap: 8px; border-left: 1px solid var(--border); padding-left: 15px; }
        input[type=range] { width: 80px; accent-color: var(--accent); }
        .speed-label { font-size: 0.7rem; font-weight: bold; color: var(--text-muted); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal-card {
            background: var(--card-bg); padding: 30px; border-radius: 20px;
            max-width: 500px; width: 90%; color: white; border: 1px solid var(--border);
        }
        textarea {
            width: 100%; height: 100px; background: #0f172a; border: 1px solid #475569; color: white;
            padding: 10px; border-radius: 8px; font-family: monospace; margin-bottom: 10px;
        }
        input[type=text] {
            width: 100%; background: #0f172a; border: 1px solid #475569; color: white;
            padding: 8px; border-radius: 8px; margin-bottom: 20px;
        }

    </style>
</head>
<body>

    <h1>Markov Chain</h1>
    <p class="subtitle">Visualizing Stochastic Processes</p>

    <div class="layout-grid">
        
        <div class="diagram-card" id="diagram">
            <svg class="svg-layer" id="svgLayer">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#475569" />
                    </marker>
                    <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#38bdf8" />
                    </marker>
                </defs>
            </svg>
            </div>

        <div class="stats-card">
            <div class="main-status">
                <div class="big-icon" id="mainIcon">‚òÄÔ∏è</div>
                <div class="step-count">Steps: <span id="stepEl">0</span></div>
            </div>

            <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">
                <strong>Goal:</strong> Match the white lines (Stationary Distribution).
            </div>

            <div id="barsContainer">
                </div>
        </div>

    </div>

    <div class="controls-bar">
        <select id="presetSelect" onchange="loadPreset()">
            <option value="weather">Weather (2)</option>
            <option value="brand">Brand Loyalty (2)</option>
            <option value="life">Dev Life (3)</option>
            <option value="custom">Custom...</option>
        </select>

        <button onclick="manualStep()">+1 Step</button>
        <button id="btnStart" class="primary" onclick="toggleSim()">Run</button>
        <button onclick="resetSim()" title="Reset">‚Ü∫</button>
        
        <div class="speed-control">
            <span class="speed-label">SPEED</span>
            <input type="range" id="speedRange" min="1" max="100" value="10">
        </div>
        
        <button onclick="toggleMute()" id="muteBtn" style="opacity:0.6">üîä</button>
    </div>

    <div class="modal-overlay" id="customModal">
        <div class="modal-card">
            <h2 style="margin-top:0">Custom Matrix</h2>
            <p style="font-size:0.9rem; color:#94a3b8">Enter a Transition Matrix (JSON format). Rows must sum to 1.0.</p>
            
            <textarea id="matrixInput">[
  [0.5, 0.25, 0.25], 
  [0.25, 0.5, 0.25], 
  [0.25, 0.25, 0.5]
]</textarea>
            
            <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:5px;">State Labels:</p>
            <input type="text" id="labelsInput" value="State A, State B, State C">
            
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="document.getElementById('customModal').classList.remove('active')">Cancel</button>
                <button class="primary" onclick="applyCustom()">Load Simulation</button>
            </div>
        </div>
    </div>

    <script>
        // --- PRESETS ---
        const presets = {
            weather: {
                labels: ["Sunny", "Rainy"],
                icons: ["‚òÄÔ∏è", "üåßÔ∏è"],
                colors: ["#f59e0b", "#3b82f6"],
                matrix: [[0.7, 0.3], [0.4, 0.6]],
                stationary: [57.1, 42.9] 
            },
            brand: {
                labels: ["Coke", "Pepsi"],
                icons: ["ü•§", "üîµ"],
                colors: ["#ef4444", "#3b82f6"],
                matrix: [[0.9, 0.1], [0.1, 0.9]],
                stationary: [50.0, 50.0]
            },
            life: {
                labels: ["Eat", "Sleep", "Code"],
                icons: ["üçî", "üí§", "üíª"],
                colors: ["#f97316", "#a855f7", "#22c55e"],
                matrix: [
                    [0.1, 0.4, 0.5], 
                    [0.1, 0.8, 0.1], 
                    [0.3, 0.2, 0.5]
                ],
                stationary: [14.0, 60.0, 26.0] 
            }
        };

        // --- STATE ---
        let config = null;
        let currentState = 0;
        let counts = [];
        let totalSteps = 0;
        let isRunning = false;
        let animFrame;

        // --- AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMuted = false;

        function playSound(idx) {
            if (isMuted || audioCtx.state === 'suspended') return;
            const speed = parseInt(document.getElementById('speedRange').value);
            if(speed > 40) return; // Too fast for audio

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // Pentatonic Scale
            const freqs = [261.63, 293.66, 329.63, 392.00, 440.00]; 
            osc.frequency.value = freqs[idx % freqs.length];
            
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

        // --- SETUP ---
        function loadPreset() {
            const key = document.getElementById('presetSelect').value;
            if(key === 'custom') {
                document.getElementById('customModal').classList.add('active');
                return;
            }
            init(presets[key]);
        }

        function applyCustom() {
            try {
                const mat = JSON.parse(document.getElementById('matrixInput').value);
                const labels = document.getElementById('labelsInput').value.split(',').map(s=>s.trim());
                if(!Array.isArray(mat)) throw new Error("Invalid Matrix");

                const cfg = {
                    labels: labels,
                    icons: labels.map((_,i)=> String.fromCharCode(65+i)), // A, B, C...
                    colors: labels.map((_,i) => `hsl(${i * 60 + 200}, 80%, 60%)`),
                    matrix: mat,
                    stationary: [] 
                };
                document.getElementById('customModal').classList.remove('active');
                init(cfg);
            } catch(e) {
                alert("Invalid JSON: " + e.message);
            }
        }

        function init(cfg) {
            config = cfg;
            currentState = 0;
            totalSteps = 0;
            counts = new Array(cfg.matrix.length).fill(0);
            document.getElementById('mainIcon').innerText = cfg.icons[0];
            
            renderDiagram();
            renderStats();
            updateUI();
            resetSim();
        }

        function renderDiagram() {
            const container = document.getElementById('diagram');
            const svg = document.getElementById('svgLayer');
            
            // Clear nodes (keep svg)
            Array.from(container.children).forEach(c => {
                if(c.id !== 'svgLayer') container.removeChild(c);
            });
            
            // Reset SVG Arrows
            while (svg.children.length > 1) { // Keep defs
                svg.removeChild(svg.lastChild);
            }

            const w = container.clientWidth;
            const h = container.clientHeight;
            const count = config.matrix.length;
            
            // Layout Logic: Circular
            const positions = [];
            const r = count === 2 ? 120 : 130;
            const centerOffset = count === 2 ? Math.PI : -Math.PI/2;

            for(let i=0; i<count; i++) {
                const angle = (i/count)*Math.PI*2 + centerOffset;
                positions.push({
                    x: (w/2) + Math.cos(angle)*r,
                    y: (h/2) + Math.sin(angle)*r
                });
            }

            // Create Nodes
            config.labels.forEach((lbl, i) => {
                const node = document.createElement('div');
                node.className = 'state-node';
                node.id = `node-${i}`;
                node.style.left = positions[i].x + 'px';
                node.style.top = positions[i].y + 'px';
                node.innerHTML = `<div class="state-icon">${config.icons[i]}</div><div class="state-label">${lbl}</div>`;
                container.appendChild(node);
            });

            // Draw Paths
            setTimeout(() => {
                for(let i=0; i<count; i++) {
                    for(let j=0; j<count; j++) {
                        if(config.matrix[i][j] > 0) {
                            drawArrow(i, j, positions);
                        }
                    }
                }
            }, 50);
        }

        function drawArrow(from, to, positions) {
            const svg = document.getElementById('svgLayer');
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.id = `path-${from}-${to}`;
            path.setAttribute("marker-end", "url(#arrowhead)");
            
            const p1 = positions[from];
            const p2 = positions[to];
            let d = "";

            if(from === to) {
                // Loop: Draw a little circle above the node
                const nx = p1.x - 40; // Offset based on node radius
                const ny = p1.y - 40;
                d = `M ${p1.x} ${p1.y-40} C ${p1.x-50} ${p1.y-100}, ${p1.x+50} ${p1.y-100}, ${p1.x} ${p1.y-40}`;
            } else {
                // Curved Line between nodes
                const mx = (p1.x + p2.x)/2;
                const my = (p1.y + p2.y)/2;
                
                // Offset curve logic
                let offset = 30;
                if(config.matrix.length === 2 && from === 1) offset = -30; // Flip for bottom curve
                
                // Calculate normal vector for curve
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const normX = -dy / dist;
                const normY = dx / dist;

                const cx = mx + (normX * offset);
                const cy = my + (normY * offset);

                d = `M ${p1.x} ${p1.y} Q ${cx} ${cy} ${p2.x} ${p2.y}`;
            }
            path.setAttribute("d", d);
            svg.appendChild(path);
        }

        function renderStats() {
            const container = document.getElementById('barsContainer');
            container.innerHTML = '';

            config.labels.forEach((lbl, i) => {
                const div = document.createElement('div');
                div.className = 'bar-group';
                
                const markerHtml = config.stationary && config.stationary[i] 
                    ? `<div class="marker" style="left: ${config.stationary[i]}%"></div>` 
                    : '';

                div.innerHTML = `
                    <div class="bar-header">
                        <span style="color:${config.colors[i]}">${lbl}</span>
                        <span id="pct-${i}">0%</span>
                    </div>
                    <div class="track">
                        <div class="fill" id="bar-${i}" style="background: ${config.colors[i]}; width: 0%"></div>
                        ${markerHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- SIMULATION ---
        function step() {
            const row = config.matrix[currentState];
            const r = Math.random();
            let sum = 0; 
            let next = 0;
            
            for(let i=0; i<row.length; i++) {
                sum += row[i];
                if(r < sum) { next = i; break; }
            }

            // Visuals
            const path = document.getElementById(`path-${currentState}-${next}`);
            if(path) {
                // Swap marker color for glow effect
                path.setAttribute("marker-end", "url(#arrowhead-active)");
                path.classList.add('active-path');
                setTimeout(()=> {
                    path.classList.remove('active-path');
                    path.setAttribute("marker-end", "url(#arrowhead)");
                }, 400);
            }

            currentState = next;
            counts[currentState]++;
            totalSteps++;
            
            playSound(currentState);
            updateUI();
        }

        function updateUI() {
            // Nodes
            document.querySelectorAll('.state-node').forEach(b => b.classList.remove('active'));
            document.getElementById(`node-${currentState}`).classList.add('active');
            
            // Icon
            document.getElementById('mainIcon').innerText = config.icons[currentState];

            // Stats
            document.getElementById('stepEl').innerText = totalSteps.toLocaleString();
            counts.forEach((c, i) => {
                const pct = totalSteps===0 ? 0 : (c/totalSteps * 100).toFixed(1);
                document.getElementById(`pct-${i}`).innerText = pct + "%";
                document.getElementById(`bar-${i}`).style.width = pct + "%";
            });
        }

        function resetSim() {
            isRunning = false;
            cancelAnimationFrame(animFrame);
            document.getElementById('btnStart').innerText = "Run";
            currentState = 0;
            totalSteps = 0;
            counts = new Array(config.matrix.length).fill(0);
            updateUI();
        }

        function toggleSim() {
            isRunning = !isRunning;
            const btn = document.getElementById('btnStart');
            if(isRunning) {
                btn.innerText = "Pause";
                if(audioCtx.state === 'suspended') audioCtx.resume();
                loop();
            } else {
                btn.innerText = "Run";
                cancelAnimationFrame(animFrame);
            }
        }

        function manualStep() {
            if(isRunning) toggleSim();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            step();
        }

        function loop() {
            if(!isRunning) return;
            const speed = parseInt(document.getElementById('speedRange').value);
            let steps = 1;
            if(speed > 50) steps = Math.floor(Math.pow(speed-40, 1.6));

            for(let i=0; i<steps; i++) step();

            let delay = speed < 40 ? (40-speed)*10 : 0;
            if(delay > 0) setTimeout(() => animFrame = requestAnimationFrame(loop), delay);
            else animFrame = requestAnimationFrame(loop);
        }

        function toggleMute() { 
            isMuted = !isMuted;
            document.getElementById('muteBtn').style.opacity = isMuted ? "0.3" : "1";
        }

        // Init
        window.onload = () => loadPreset();
        window.onresize = () => renderDiagram(); // Re-center diagram on resize
    </script>
</body>
</html>
