<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markov Chain Simulator</title>
    <link rel="icon" href="../favicon.ico">
    <style>
        :root {
            /* Restoring the Original Color Scheme */
            --bg-color: #F2C94C; 
            --text-color: #2c3e50;
            --container-bg: rgba(0, 0, 0, 0.55);
            --accent: #e67e22;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease;
        }

        h1 { margin-bottom: 5px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        p.subtitle { margin-top: 0; margin-bottom: 25px; opacity: 0.9; }

        /* --- THE MAIN STAGE --- */
        .main-stage {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; margin-bottom: 30px; width: 100%;
        }

        .icon-display {
            font-size: 4.5rem; height: 100px; display: flex; align-items: center;opacity:0.85;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* The Diagram Box */
        .diagram-container {
            position: relative;
            width: 100%; max-width: 600px; height: 300px;
            background: var(--container-bg);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            /* We use absolute positioning for nodes inside here now */
        }

        /* SVG Arrows */
        .svg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        path {
            fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 2; transition: stroke 0.2s;
        }
        path.active-path {
            stroke: var(--accent); stroke-width: 3; filter: drop-shadow(0 0 3px var(--accent));
        }

        /* The State Boxes (Nodes) */
        .state-box {
            position: absolute; /* Placed via JS */
            width: 100px; height: 80px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.2s;
            transform: translate(-50%, -50%); /* Center anchor */
            z-index: 10;
        }
        .state-box.active {
            opacity: 1; transform: translate(-50%, -50%) scale(1.15);
            background: rgba(255,255,255,0.2); border-color: white;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }
        .state-name { font-size: 1rem; font-weight: bold; }
        .state-icon { font-size: 1.5rem; margin-bottom: 5px; }

        /* --- STATS BARS (Restored) --- */
        .stats-container {
            width: 100%; max-width: 600px;
            background: var(--container-bg);
            padding: 20px; border-radius: 15px;
            backdrop-filter: blur(5px); margin-bottom: 20px;
        }
        .bar-group { margin-bottom: 15px; }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        .progress-bg {
            width: 100%; height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; position: relative;
        }
        .progress-fill { height: 100%; width: 0%; transition: width 0.1s; }
        /* THE WHITE LINE IS BACK */
        .marker {
            position: absolute; top: 0; bottom: 0; width: 3px; background: #fff;
            z-index: 10; box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        /* --- CONTROLS --- */
        .controls {
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
            background: rgba(0,0,0,0.3); padding: 15px 25px; border-radius: 50px; align-items: center;
        }

        button, select {
            padding: 10px 20px; border-radius: 25px; border: none; font-weight: 700; cursor: pointer;
            background: #ecf0f1; color: #2c3e50; transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        .btn-primary { background: #e67e22; color: white; }
        
        input[type=range] { accent-color: #e67e22; width: 100px; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-card {
            background: #ecf0f1; padding: 30px; border-radius: 20px;
            max-width: 500px; width: 90%; color: #2d3436; position: relative;
        }
        textarea {
            width: 100%; height: 100px; background: #dfe6e9; border: 1px solid #b2bec3;
            padding: 10px; border-radius: 5px; font-family: monospace;
        }

        /* Helper for the Target Info Box */
        .info-box {
            background: rgba(255,255,255,0.1); padding: 10px 20px; 
            border-radius: 10px; font-size: 0.9rem; text-align: center; 
            max-width: 600px; margin-bottom: 20px; border-left: 4px solid #e67e22;
        }
    </style>
</head>
<body>

    <h1>Markov Chain</h1>
    <p class="subtitle">Exploring Stationarity</p>

    <div style="margin-bottom: 20px; display:flex; gap:10px;">
        <select id="presetSelect" onchange="loadPreset()">
            <option value="weather">Weather (2-State)</option>
            <option value="brand">Brand Loyalty (2-State)</option>
            <option value="life">Eat Sleep Code (3-State)</option>
            <option value="custom">Custom Inputs...</option>
        </select>
        <button onclick="toggleMute()" id="muteBtn" title="Sound">üîä</button>
    </div>

    <div class="info-box">
        <strong>üéØ Goal:</strong> Reach the "Stationary Distribution" (The White Line).<br>
        <span style="opacity: 0.8; font-size: 0.8rem;">Run Fast and watch the colored bars align with the white markers.</span>
    </div>

    <div class="main-stage">
        <div class="icon-display" id="mainIcon">‚òÄÔ∏è</div>
        
        <div class="diagram-container" id="diagram">
            <svg class="svg-layer" id="svgLayer">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.4)" />
                    </marker>
                </defs>
            </svg>
            </div>
    </div>

    <div class="stats-container" id="statsContainer">
        <div style="text-align: center; margin-bottom: 15px; opacity: 0.8; font-family: monospace;">
            Steps: <span id="stepEl">0</span>
        </div>
        </div>

    <div class="controls">
        <button onclick="manualStep()">+1 Step</button>
        <button id="btnStart" class="btn-primary" onclick="toggleSim()">Run Fast</button>
        
        <div style="display:flex; flex-direction: column; align-items:center; margin: 0 10px;">
            <span style="font-size:0.6rem; font-weight:bold; margin-bottom: 2px;">SPEED</span>
            <input type="range" id="speedRange" min="1" max="100" value="10">
        </div>

        <button onclick="resetSim()">Reset</button>
    </div>

    <div class="modal-overlay" id="customModal">
        <div class="modal-card">
            <h2>Custom Probabilities</h2>
            <p>Enter a Matrix (JSON). Rows must sum to 1.0.</p>
            <textarea id="matrixInput">[
  [0.5, 0.25, 0.25], 
  [0.25, 0.5, 0.25], 
  [0.25, 0.25, 0.5]
]</textarea>
            <p>Labels:</p>
            <input type="text" id="labelsInput" value="A, B, C" style="width:100%; padding:8px; margin-bottom:15px;">
            <button class="btn-primary" onclick="applyCustom()">Load</button>
            <button onclick="document.getElementById('customModal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <script>
        // --- PRESETS ---
        // We hardcode 'stationary' here because calculating it in JS is heavy math.
        const presets = {
            weather: {
                labels: ["Sunny", "Rainy"],
                icons: ["‚òÄÔ∏è", "üåßÔ∏è"],
                colors: ["#f1c40f", "#3498db"],
                bg: "#f1c40f",
                matrix: [[0.7, 0.3], [0.4, 0.6]],
                stationary: [57.1, 42.9] 
            },
            brand: {
                labels: ["Brand A", "Brand B"],
                icons: ["üÖ∞Ô∏è", "üÖ±Ô∏è"],
                colors: ["#e74c3c", "#8e44ad"],
                bg: "#c0392b",
                matrix: [[0.9, 0.1], [0.1, 0.9]],
                stationary: [50.0, 50.0]
            },
            life: {
                labels: ["Eat", "Sleep", "Code"],
                icons: ["üçî", "üí§", "üíª"],
                colors: ["#e67e22", "#9b59b6", "#2ecc71"],
                bg: "#27ae60",
                matrix: [
                    [0.1, 0.4, 0.5], 
                    [0.1, 0.8, 0.1], 
                    [0.3, 0.2, 0.5]
                ],
                // Approximation of stationary dist
                stationary: [14.0, 60.0, 26.0] 
            }
        };

        // --- STATE ---
        let config = null;
        let currentState = 0;
        let counts = [];
        let totalSteps = 0;
        let isRunning = false;
        let animFrame;

        // --- AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMuted = false;

        function playSound(idx) {
            if (isMuted || audioCtx.state === 'suspended') return;
            const speed = parseInt(document.getElementById('speedRange').value);
            if(speed > 40) return; 

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // Simple major chord tones
            const freqs = [261.6, 329.6, 392.0, 523.2, 659.3]; // C Major
            osc.frequency.value = freqs[idx % freqs.length];
            
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- SETUP & RENDER ---
        function loadPreset() {
            const key = document.getElementById('presetSelect').value;
            if(key === 'custom') {
                document.getElementById('customModal').classList.add('active');
                return;
            }
            init(presets[key]);
        }

        function applyCustom() {
            try {
                const mat = JSON.parse(document.getElementById('matrixInput').value);
                const labels = document.getElementById('labelsInput').value.split(',').map(s=>s.trim());
                if(!Array.isArray(mat)) throw new Error("Invalid Matrix");

                const cfg = {
                    labels: labels,
                    icons: labels.map((_,i)=> String.fromCharCode(65+i)),
                    colors: labels.map((_,i) => `hsl(${i * 60}, 70%, 50%)`),
                    bg: "#34495e", // Neutral BG for custom
                    matrix: mat,
                    stationary: [] // No white lines for custom
                };
                document.getElementById('customModal').classList.remove('active');
                init(cfg);
            } catch(e) {
                alert("Invalid JSON: " + e.message);
            }
        }

        function init(cfg) {
            config = cfg;
            currentState = 0;
            totalSteps = 0;
            counts = new Array(cfg.matrix.length).fill(0);
            document.body.style.backgroundColor = cfg.bg;
            document.getElementById('mainIcon').innerText = cfg.icons[0];
            
            renderDiagram();
            renderStats();
            updateUI();
            resetSim();
        }

        function renderDiagram() {
            const container = document.getElementById('diagram');
            const svg = document.getElementById('svgLayer');
            
            // Clear boxes (keep svg)
            Array.from(container.children).forEach(c => {
                if(c.id !== 'svgLayer') container.removeChild(c);
            });
            svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.4)" /></marker></defs>';

            const w = 600, h = 300;
            const count = config.matrix.length;
            
            // Layout Logic: 2=Left/Right, 3=Triangle
            const positions = [];
            if(count === 2) {
                positions.push({x: 150, y: 150});
                positions.push({x: 450, y: 150});
            } else {
                // Circle layout for 3+
                const r = 100;
                for(let i=0; i<count; i++) {
                    const angle = (i/count)*Math.PI*2 - Math.PI/2;
                    positions.push({
                        x: 300 + Math.cos(angle)*r,
                        y: 150 + Math.sin(angle)*r
                    });
                }
            }

            // Create Boxes
            config.labels.forEach((lbl, i) => {
                const box = document.createElement('div');
                box.className = 'state-box';
                box.id = `box-${i}`;
                box.style.left = positions[i].x + 'px';
                box.style.top = positions[i].y + 'px';
                box.innerHTML = `<div class="state-icon">${config.icons[i]}</div><div class="state-name">${lbl}</div>`;
                container.appendChild(box);
            });

            // Draw Paths
            setTimeout(() => {
                for(let i=0; i<count; i++) {
                    for(let j=0; j<count; j++) {
                        if(config.matrix[i][j] > 0) {
                            drawArrow(i, j, positions);
                        }
                    }
                }
            }, 50);
        }

        function drawArrow(from, to, positions) {
            const svg = document.getElementById('svgLayer');
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.id = `path-${from}-${to}`;
            path.setAttribute("marker-end", "url(#arrowhead)");
            
            const p1 = positions[from];
            const p2 = positions[to];
            let d = "";

            if(from === to) {
                // Loop
                d = `M ${p1.x} ${p1.y-40} C ${p1.x-50} ${p1.y-100}, ${p1.x+50} ${p1.y-100}, ${p1.x} ${p1.y-40}`;
            } else {
                // Line with slight curve
                const mx = (p1.x + p2.x)/2;
                const my = (p1.y + p2.y)/2;
                // Offset curve slightly so A->B and B->A don't overlap
                const offset = 20; 
                d = `M ${p1.x} ${p1.y} Q ${mx} ${my-offset} ${p2.x} ${p2.y}`;
                if (config.matrix.length === 2 && from === 1) {
                     d = `M ${p1.x} ${p1.y} Q ${mx} ${my+offset} ${p2.x} ${p2.y}`; // Bottom arch for 2nd
                }
            }
            path.setAttribute("d", d);
            svg.appendChild(path);
        }

        function renderStats() {
            const container = document.getElementById('statsContainer');
            // Remove old bars, keep header
            while(container.children.length > 1) container.removeChild(container.lastChild);

            config.labels.forEach((lbl, i) => {
                const div = document.createElement('div');
                div.className = 'bar-group';
                
                // Only show white line if we have stationary data
                const markerHtml = config.stationary && config.stationary[i] 
                    ? `<div class="marker" style="left: ${config.stationary[i]}%"></div>` 
                    : '';

                div.innerHTML = `
                    <div class="bar-label"><span>${lbl}</span> <span id="pct-${i}">0%</span></div>
                    <div class="progress-bg">
                        <div class="progress-fill" id="bar-${i}" style="background: ${config.colors[i]}"></div>
                        ${markerHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- SIMULATION ---
        function step() {
            const row = config.matrix[currentState];
            const r = Math.random();
            let sum = 0; 
            let next = 0;
            
            for(let i=0; i<row.length; i++) {
                sum += row[i];
                if(r < sum) { next = i; break; }
            }

            // Visuals
            const path = document.getElementById(`path-${currentState}-${next}`);
            if(path) {
                path.classList.add('active-path');
                setTimeout(()=>path.classList.remove('active-path'), 200);
            }

            currentState = next;
            counts[currentState]++;
            totalSteps++;
            
            playSound(currentState);
            updateUI();
        }

        function updateUI() {
            // Highlight Box
            document.querySelectorAll('.state-box').forEach(b => b.classList.remove('active'));
            document.getElementById(`box-${currentState}`).classList.add('active');
            
            // Icon
            document.getElementById('mainIcon').innerText = config.icons[currentState];

            // Stats
            document.getElementById('stepEl').innerText = totalSteps.toLocaleString();
            counts.forEach((c, i) => {
                const pct = totalSteps===0 ? 0 : (c/totalSteps * 100).toFixed(1);
                document.getElementById(`pct-${i}`).innerText = pct + "%";
                document.getElementById(`bar-${i}`).style.width = pct + "%";
            });
        }

        function resetSim() {
            isRunning = false;
            cancelAnimationFrame(animFrame);
            document.getElementById('btnStart').innerText = "Run Fast";
            currentState = 0;
            totalSteps = 0;
            counts = new Array(config.matrix.length).fill(0);
            updateUI();
        }

        function toggleSim() {
            isRunning = !isRunning;
            const btn = document.getElementById('btnStart');
            if(isRunning) {
                btn.innerText = "Pause";
                if(audioCtx.state === 'suspended') audioCtx.resume();
                loop();
            } else {
                btn.innerText = "Run Fast";
                cancelAnimationFrame(animFrame);
            }
        }

        function manualStep() {
            if(isRunning) toggleSim();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            step();
        }

        function loop() {
            if(!isRunning) return;
            const speed = parseInt(document.getElementById('speedRange').value);
            let steps = 1;
            if(speed > 50) steps = Math.floor(Math.pow(speed-40, 1.6));

            for(let i=0; i<steps; i++) step();

            let delay = speed < 40 ? (40-speed)*10 : 0;
            if(delay > 0) setTimeout(() => animFrame = requestAnimationFrame(loop), delay);
            else animFrame = requestAnimationFrame(loop);
        }

        function toggleMute() { 
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? 'üîá' : 'üîä';
        }

        // Init
        window.onload = () => loadPreset();
    </script>
</body>
</html>

