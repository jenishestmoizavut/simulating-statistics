<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markov Chain Studio</title>
    <link rel="icon" href="../favicon.ico">
    <style>
        :root {
            --bg-grad-1: #1e3c72;
            --bg-grad-2: #2a5298;
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --accent-color: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            color: var(--text-color);
            margin: 0; padding: 20px;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        h1 { margin: 10px 0 5px; font-weight: 300; letter-spacing: 3px; text-transform: uppercase; text-align: center; }
        .subtitle { font-size: 0.9rem; opacity: 0.7; margin-bottom: 20px; font-style: italic; text-align: center; }

        /* --- CONTROLS --- */
        .controls-top {
            background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 50px;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center;
            margin-bottom: 30px; backdrop-filter: blur(10px);
            z-index: 100;
        }

        select, button {
            background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        /* FIX: Dropdown colors for all browsers */
        select option { background-color: #2c3e50; color: white; }
        
        select:focus, button:hover { background: rgba(255,255,255,0.25); outline: none; transform: translateY(-1px); }
        .btn-action { background: var(--accent-color); color: #2c3e50; font-weight: bold; border: none; }
        .btn-action:active { transform: scale(0.95); }

        /* --- STAGE CONTAINER --- */
        .stage-container {
            position: relative; width: 100%; max-width: 700px; min-height: 350px;
            margin-bottom: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        
        .svg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        
        path {
            fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 2;
            transition: stroke 0.3s;
        }
        path.active-path {
            stroke: var(--accent-color); stroke-width: 4;
            filter: drop-shadow(0 0 8px var(--accent-color));
        }

        /* --- NODES (The "Boxes") --- */
        .node {
            background: var(--card-bg);
            border: 2px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .node.active {
            transform: scale(1.1);
            border-color: #fff; background: rgba(255,255,255,0.25);
            box-shadow: 0 0 30px rgba(255,255,255,0.4);
            z-index: 20;
        }
        .node-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .node-label { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        /* --- LAYOUT MODES --- */
        
        /* 1. CLASSIC 2-STATE LAYOUT */
        .layout-classic .node {
            width: 140px; height: 140px; border-radius: 20px;
            position: absolute; top: 50%; transform: translateY(-50%);
        }
        /* Positions for Left/Right boxes */
        .layout-classic .node:nth-child(1) { left: 10%; } /* Node 0 */
        .layout-classic .node:nth-child(2) { right: 10%; } /* Node 1 */
        
        /* 2. CIRCLE N-STATE LAYOUT */
        .layout-circle .node {
            width: 100px; height: 100px; border-radius: 50%; /* Circle nodes for 3+ */
            position: absolute; transform: translate(-50%, -50%);
        }
        .layout-circle .node-icon { font-size: 2rem; }
        .layout-circle .node-label { font-size: 0.7rem; }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px; width: 100%; max-width: 600px; margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; text-align: center;
            border-bottom: 4px solid transparent; transition: background 0.2s;
        }
        .stat-card:hover { background: rgba(0,0,0,0.3); }
        .stat-val { font-size: 1.4rem; font-weight: bold; font-family: monospace; }
        .stat-name { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 200;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2c3e50; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; color: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative;
        }
        textarea {
            width: 100%; height: 120px; background: rgba(0,0,0,0.3); color: #00cec9; 
            border: 1px solid #555; padding: 10px; font-family: monospace; border-radius: 5px; margin: 10px 0;
            box-sizing: border-box;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Markov Chain Studio</h1>
    <p class="subtitle">Simulating random walks through state spaces</p>

    <div class="controls-top">
        <select id="presetSelect" onchange="loadPreset()">
            <option value="weather">2-State: Weather</option>
            <option value="brand">2-State: Brand Loyalty</option>
            <option value="life">3-State: Eat Sleep Code</option>
            <option value="rps">3-State: Rock Paper Scissors</option>
            <option value="custom">Custom Matrix...</option>
        </select>
        
        <button onclick="toggleInfo()" title="Learn more">‚ÑπÔ∏è</button>
        <button onclick="toggleMute()" id="muteBtn" title="Sound">üîä</button>
    </div>

    <div class="stage-container layout-classic" id="stage">
        <svg class="svg-layer" id="svgLayer">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.3)" />
                </marker>
            </defs>
            </svg>
        </div>

    <div class="stats-grid" id="statsGrid"></div>

    <div style="text-align:center; font-family: monospace; opacity: 0.6; margin-bottom: 20px;">
        TOTAL STEPS: <span id="stepCount">0</span>
    </div>

    <div class="controls-top">
        <button class="btn-action" onclick="manualStep()">+1 Step</button>
        <button class="btn-action" id="runBtn" onclick="toggleRun()">Run Fast</button>
        <div style="display:flex; flex-direction:column; align-items:center; margin-left: 5px;">
            <span style="font-size:0.6rem;">SPEED</span>
            <input type="range" id="speedRange" min="1" max="100" value="10">
        </div>
        <button onclick="reset()">Reset</button>
    </div>

    <div class="modal" id="infoModal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleInfo()">&times;</span>
            <h2>Understanding the Chain</h2>
            <p>A Markov Chain is a system that transitions from one state to another purely based on probability.</p>
            <ul>
                <li><strong>Memoryless:</strong> It doesn't care about the past. Only the current state decides what happens next.</li>
                <li><strong>Stationarity:</strong> Run it long enough, and the percentages often settle into a stable "equilibrium" (the Stationary Distribution).</li>
            </ul>
        </div>
    </div>

    <div class="modal" id="customModal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('customModal').classList.remove('open')">&times;</span>
            <h2>Custom Matrix Input</h2>
            <p style="font-size:0.9rem; opacity:0.8;">Enter a square JSON matrix (rows sum to 1.0).</p>
            
            <textarea id="matrixInput" spellcheck="false">
[
  [0.5, 0.5], 
  [0.5, 0.5]
]</textarea>
            
            <label style="font-size:0.8rem;">Labels (comma separated):</label>
            <input type="text" id="labelsInput" value="A, B" style="width:100%; padding:8px; margin-top:5px; background:rgba(0,0,0,0.3); color:white; border:1px solid #555; border-radius: 5px; box-sizing: border-box;">
            
            <button class="btn-action" style="margin-top:15px; width:100%;" onclick="applyCustom()">Load Simulation</button>
            <p id="errorMsg" style="color: #ff7675; font-size: 0.8rem; margin-top: 10px;"></p>
        </div>
    </div>

    <script>
        // --- PRESETS DATABASE ---
        const presets = {
            weather: {
                labels: ["Sunny", "Rainy"],
                icons: ["‚òÄÔ∏è", "üåßÔ∏è"],
                matrix: [[0.7, 0.3], [0.4, 0.6]],
                colors: ["#f1c40f", "#3498db"]
            },
            brand: {
                labels: ["Coke", "Pepsi"],
                icons: ["ü•§", "üü¶"],
                matrix: [[0.9, 0.1], [0.2, 0.8]], // Sticky brands
                colors: ["#e74c3c", "#3498db"]
            },
            life: {
                labels: ["Eat", "Sleep", "Code"],
                icons: ["üçî", "üí§", "üíª"],
                matrix: [
                    [0.1, 0.2, 0.7], // Eat -> Code usually
                    [0.1, 0.6, 0.3], // Sleep -> Sleep more
                    [0.3, 0.2, 0.5]  // Code -> Loop
                ],
                colors: ["#e67e22", "#9b59b6", "#2ecc71"]
            },
            rps: {
                labels: ["Rock", "Paper", "Scissors"],
                icons: ["ü™®", "üìÑ", "‚úÇÔ∏è"],
                matrix: [[0.33, 0.33, 0.34], [0.34, 0.33, 0.33], [0.33, 0.34, 0.33]],
                colors: ["#95a5a6", "#ecf0f1", "#e74c3c"]
            }
        };

        // --- GLOBAL STATE ---
        let currentConfig = null;
        let currentState = 0;
        let counts = [];
        let totalSteps = 0;
        let isRunning = false;
        let animFrame;
        
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMuted = false;

        function playSound(idx) {
            if (isMuted || audioCtx.state === 'suspended') return;
            const speed = parseInt(document.getElementById('speedRange').value);
            if(speed > 40) return; // Save ears

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            // Pentatonic scale logic
            const base = 220;
            const ratios = [1, 1.125, 1.25, 1.5, 1.66];
            const freq = base * (ratios[idx % 5] || 2);

            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

        // --- CORE FUNCTIONS ---
        function loadPreset() {
            const val = document.getElementById('presetSelect').value;
            if(val === 'custom') {
                document.getElementById('customModal').classList.add('open');
                return;
            }
            setup(presets[val]);
        }

        function applyCustom() {
            const txt = document.getElementById('matrixInput').value;
            const lbls = document.getElementById('labelsInput').value.split(',').map(s=>s.trim());
            
            try {
                const mat = JSON.parse(txt);
                if(!Array.isArray(mat) || mat.length < 2) throw new Error("Matrix must be array of size 2+");
                
                // Construct config
                const cfg = {
                    labels: lbls.slice(0, mat.length),
                    icons: mat.map((_, i) => String.fromCharCode(65+i)), // A, B, C default icons
                    matrix: mat,
                    colors: mat.map((_,i) => `hsl(${i * (360/mat.length)}, 70%, 50%)`)
                };
                
                document.getElementById('customModal').classList.remove('open');
                setup(cfg);
            } catch(e) {
                document.getElementById('errorMsg').innerText = "Error: " + e.message;
            }
        }

        function setup(config) {
            currentConfig = config;
            currentState = 0;
            totalSteps = 0;
            counts = new Array(config.matrix.length).fill(0);
            
            renderLayout(config);
            renderStats(config);
            updateStatsUI();
        }

        function renderLayout(config) {
            const stage = document.getElementById('stage');
            const svg = document.getElementById('svgLayer');
            
            // Clear
            // Keep the svgLayer, remove other children (nodes)
            Array.from(stage.children).forEach(c => {
                if(c.id !== 'svgLayer') stage.removeChild(c);
            });
            svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="28" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.3)" /></marker></defs>';

            // Switch Class based on count
            const count = config.matrix.length;
            if (count === 2) {
                stage.className = "stage-container layout-classic";
                renderClassicNodes(config);
            } else {
                stage.className = "stage-container layout-circle";
                renderCircleNodes(config);
            }
        }

        function renderClassicNodes(config) {
            const stage = document.getElementById('stage');
            
            // 1. Create Nodes (DOM)
            config.labels.forEach((lbl, i) => {
                const node = document.createElement('div');
                node.className = 'node';
                node.id = `node-${i}`;
                node.style.borderColor = config.colors[i];
                node.innerHTML = `<div class="node-icon">${config.icons[i]}</div><div class="node-label">${lbl}</div>`;
                stage.appendChild(node);
            });

            // 2. Create SVG Paths (Hardcoded beautiful curves for 2-state)
            // We wait a tick for DOM layout or just assume % positions
            // Classic Layout: Node 0 is Left (10%), Node 1 is Right (10%)
            // We can assume stage width ~ 700px. Let's use coordinate logic relative to stage.
            
            setTimeout(() => { drawPaths(true); }, 50);
        }

        function renderCircleNodes(config) {
            const stage = document.getElementById('stage');
            const count = config.matrix.length;
            const r = 130; // Radius
            const cx = stage.clientWidth / 2;
            const cy = stage.clientHeight / 2;

            config.labels.forEach((lbl, i) => {
                const angle = (i / count) * 2 * Math.PI - (Math.PI/2);
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);
                
                const node = document.createElement('div');
                node.className = 'node';
                node.id = `node-${i}`;
                node.style.left = x + 'px';
                node.style.top = y + 'px';
                node.style.borderColor = config.colors[i];
                node.innerHTML = `<div class="node-icon">${config.icons[i]}</div><div class="node-label">${lbl}</div>`;
                stage.appendChild(node);
            });

            setTimeout(() => { drawPaths(false); }, 50);
        }

        function drawPaths(isClassic) {
            const stage = document.getElementById('stage');
            const svg = document.getElementById('svgLayer');
            const num = currentConfig.matrix.length;

            // Helper to get center of a node
            const getCenter = (idx) => {
                const el = document.getElementById(`node-${idx}`);
                return {
                    x: el.offsetLeft + el.offsetWidth/2,
                    y: el.offsetTop + el.offsetHeight/2,
                    w: el.offsetWidth
                };
            };

            for(let i=0; i<num; i++) {
                for(let j=0; j<num; j++) {
                    if(currentConfig.matrix[i][j] > 0) {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        path.id = `path-${i}-${j}`;
                        path.setAttribute("marker-end", "url(#arrowhead)");
                        
                        const p1 = getCenter(i);
                        const p2 = getCenter(j);
                        let d = "";

                        if (isClassic) {
                            // Specialized 2-state curves
                            if (i===j) {
                                // Self Loop
                                const dir = i===0 ? -1 : 1;
                                d = `M ${p1.x} ${p1.y - 40} C ${p1.x + (50*dir)} ${p1.y - 100}, ${p1.x - (50*dir)} ${p1.y - 100}, ${p1.x} ${p1.y - 40}`; 
                                // Actually, self loops are tricky in pure SVG paths on DOM elements. 
                                // Let's do simple loops.
                                d = i===0 
                                    ? `M ${p1.x-20} ${p1.y-50} C ${p1.x-80} ${p1.y-100}, ${p1.x-80} ${p1.y+20}, ${p1.x-40} ${p1.y}`
                                    : `M ${p2.x+20} ${p2.y-50} C ${p2.x+80} ${p2.y-100}, ${p2.x+80} ${p2.y+20}, ${p2.x+40} ${p2.y}`;
                            } else {
                                // Cross arrows
                                if (i===0) d = `M ${p1.x+40} ${p1.y-20} Q ${(p1.x+p2.x)/2} ${p1.y-80} ${p2.x-40} ${p2.y-20}`; // Top arch
                                else       d = `M ${p1.x-40} ${p1.y+20} Q ${(p1.x+p2.x)/2} ${p1.y+80} ${p2.x+40} ${p2.y+20}`; // Bottom arch
                            }
                        } else {
                            // General N-state lines
                            if(i===j) {
                                // Simple self loop bubble
                                d = `M ${p1.x} ${p1.y-40} C ${p1.x+50} ${p1.y-100}, ${p1.x-50} ${p1.y-100}, ${p1.x} ${p1.y-40}`;
                            } else {
                                // Straight lines for clarity in complex graphs
                                d = `M ${p1.x} ${p1.y} L ${p2.x} ${p2.y}`;
                            }
                        }
                        
                        path.setAttribute("d", d);
                        svg.appendChild(path);
                    }
                }
            }
            highlightNode(0);
        }

        function renderStats(config) {
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            config.labels.forEach((lbl, i) => {
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.style.borderBottomColor = config.colors[i];
                div.innerHTML = `<div class="stat-name">${lbl}</div><div class="stat-val" id="val-${i}">0%</div>`;
                grid.appendChild(div);
            });
        }

        // --- SIMULATION LOGIC ---
        function step() {
            // Weighted Random Choice
            const row = currentConfig.matrix[currentState];
            const r = Math.random();
            let sum = 0;
            let next = -1;
            
            for(let i=0; i<row.length; i++) {
                sum += row[i];
                if(r < sum) { next = i; break; }
            }
            if(next === -1) next = row.length - 1; // Precision safety

            // Visuals
            highlightTransition(currentState, next);
            currentState = next;
            
            // Data
            totalSteps++;
            counts[currentState]++;
            
            updateStatsUI();
            playSound(currentState);
            highlightNode(currentState);
        }

        function highlightTransition(from, to) {
            const p = document.getElementById(`path-${from}-${to}`);
            if(p) {
                p.classList.add('active-path');
                setTimeout(() => p.classList.remove('active-path'), 200);
            }
        }

        function highlightNode(idx) {
            document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
            const n = document.getElementById(`node-${idx}`);
            if(n) n.classList.add('active');
        }

        function updateStatsUI() {
            document.getElementById('stepCount').innerText = totalSteps.toLocaleString();
            counts.forEach((c, i) => {
                const pct = totalSteps === 0 ? 0 : ((c/totalSteps)*100).toFixed(1);
                document.getElementById(`val-${i}`).innerText = pct + "%";
            });
        }

        // --- LOOP & CONTROL ---
        function toggleRun() {
            isRunning = !isRunning;
            const btn = document.getElementById('runBtn');
            if(isRunning) {
                btn.innerText = "Pause";
                btn.style.background = "#ff7675"; // Red for stop
                if(audioCtx.state === 'suspended') audioCtx.resume();
                loop();
            } else {
                btn.innerText = "Run Fast";
                btn.style.background = ""; // Reset
                cancelAnimationFrame(animFrame);
            }
        }

        function loop() {
            if(!isRunning) return;
            const speed = parseInt(document.getElementById('speedRange').value);
            
            let stepsPerFrame = 1;
            if(speed > 50) stepsPerFrame = Math.floor(Math.pow(speed-40, 1.6));
            
            for(let i=0; i<stepsPerFrame; i++) step();

            let delay = 0;
            if(speed < 40) delay = (40-speed) * 10;
            
            if(delay > 0) setTimeout(() => animFrame = requestAnimationFrame(loop), delay);
            else animFrame = requestAnimationFrame(loop);
        }

        function manualStep() {
            if(isRunning) toggleRun();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            step();
        }

        function reset() {
            isRunning = false;
            cancelAnimationFrame(animFrame);
            document.getElementById('runBtn').innerText = "Run Fast";
            document.getElementById('runBtn').style.background = "";
            setup(currentConfig);
        }

        function toggleInfo() { document.getElementById('infoModal').classList.toggle('open'); }
        function toggleMute() { 
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? 'üîá' : 'üîä';
        }

        // Init
        window.addEventListener('resize', () => { if(currentConfig) renderLayout(currentConfig); });
        window.onload = loadPreset;

    </script>
</body>
</html>
