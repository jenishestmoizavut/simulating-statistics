<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markov Chain Simulator</title>
    <link rel="icon" href="../favicon.ico">
    <style>
        :root {
            --bg-grad-1: #1e3c72;
            --bg-grad-2: #2a5298;
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --accent-color: #f1c40f;
            --state-a-color: #f1c40f;
            --state-b-color: #3498db;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            transition: background 0.5s;
        }

        h1 { margin: 10px 0 5px; font-weight: 300; letter-spacing: 3px; text-transform: uppercase; }
        .subtitle { font-size: 0.9rem; opacity: 0.7; margin-bottom: 30px; font-style: italic; }

        /* --- CONTROLS SECTION --- */
        .controls-top {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        select {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        select:focus { outline: none; border-color: var(--accent-color); background: #2c3e50; }

        .sound-toggle {
            cursor: pointer;
            font-size: 1.2rem;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transition: background 0.2s;
        }
        .sound-toggle:hover { background: rgba(255,255,255,0.2); }
        .sound-toggle.muted { opacity: 0.5; text-decoration: line-through; }

        /* --- VISUALIZATION STAGE --- */
        .stage-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        /* SVG Arrows Layer */
        .svg-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        path {
            fill: none;
            stroke: rgba(255,255,255,0.3);
            stroke-width: 2;
            transition: stroke 0.3s, stroke-width 0.2s;
        }
        path.active-path {
            stroke: var(--accent-color);
            stroke-width: 4;
            filter: drop-shadow(0 0 5px var(--accent-color));
        }

        /* State Nodes */
        .nodes-wrapper {
            display: flex;
            justify-content: space-between;
            width: 300px;
            z-index: 1;
        }

        .node {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            position: relative;
        }

        .node.active {
            transform: scale(1.15);
            box-shadow: 0 0 30px rgba(255,255,255,0.4);
            border-color: white;
            z-index: 2;
        }

        .node-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .node-label { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
        
        /* Particle Moving Animation */
        .particle {
            position: absolute;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px white;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
        }

        /* --- HISTORY TICKER --- */
        .ticker-container {
            width: 100%; max-width: 600px;
            height: 50px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 10px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        .ticker-container::after {
            content: ''; position: absolute; top: 0; right: 0; width: 50px; height: 100%;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.4));
        }
        .ticker-item {
            font-size: 1.5rem;
            margin-right: 10px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- STATS & CONTROLS --- */
        .dashboard {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            width: 100%; max-width: 550px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-row { margin-bottom: 15px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        
        .progress-track {
            height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; position: relative;
        }
        .progress-bar { height: 100%; transition: width 0.2s linear; }
        .target-line {
            position: absolute; top: 0; bottom: 0; width: 2px; background: white;
            box-shadow: 0 0 4px black; z-index: 5;
        }

        .action-area {
            display: flex; gap: 10px; justify-content: center; margin-top: 25px; flex-wrap: wrap;
        }

        button {
            border: none; padding: 12px 24px; border-radius: 30px; font-weight: bold; cursor: pointer;
            font-size: 0.9rem; transition: transform 0.1s, filter 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-step { background: rgba(255,255,255,0.2); color: white; }
        .btn-run { background: white; color: #333; }
        .btn-run.running { background: #ff7675; color: white; }
        
        input[type=range] { accent-color: var(--accent-color); }

        /* --- MODAL --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2c3e50; padding: 30px; border-radius: 20px; max-width: 500px; color: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <h1>Markov Chain</h1>
    <p class="subtitle">Visualizing Stochastic Processes</p>

    <div class="controls-top">
        <select id="presetSelect" onchange="loadPreset()">
            <option value="weather">Scenario: Weather (Balanced)</option>
            <option value="brand">Scenario: Sticky Brand (High Loyalty)</option>
            <option value="habit">Scenario: Bad Habit (Trap State)</option>
            <option value="gamble">Scenario: Gambler's Ruin</option>
        </select>
        <div class="sound-toggle" id="soundBtn" onclick="toggleMute()" title="Toggle Sound">
            üîä
        </div>
    </div>

    <div class="stage-container">
        <svg class="svg-layer" viewBox="0 0 600 300">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="rgba(255,255,255,0.5)" />
                </marker>
            </defs>
            <path id="pathAA" d="M 200,110 C 150,50 250,50 200,110" /> <path id="pathBB" d="M 400,110 C 350,50 450,50 400,110" /> <path id="pathAB" d="M 210,150 Q 300,100 390,150" marker-end="url(#arrowhead)"/> <path id="pathBA" d="M 390,150 Q 300,200 210,150" marker-end="url(#arrowhead)"/> </svg>

        <div class="nodes-wrapper">
            <div class="node" id="node0">
                <div class="node-icon" id="icon0">‚òÄÔ∏è</div>
                <div class="node-label" id="label0">Sunny</div>
            </div>
            <div class="node" id="node1">
                <div class="node-icon" id="icon1">üåßÔ∏è</div>
                <div class="node-label" id="label1">Rainy</div>
            </div>
        </div>
        
        <div class="particle" id="particle"></div>
    </div>

    <div class="ticker-container" id="tickerTape">
        </div>

    <div class="dashboard">
        <div style="text-align: center; font-family: monospace; opacity: 0.6; margin-bottom: 15px;">
            TOTAL STEPS: <span id="stepCount">0</span>
        </div>

        <div class="stat-row">
            <div class="stat-header">
                <span id="statName0">State A</span>
                <span id="statPct0">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-bar" id="bar0" style="width: 0%; background: var(--state-a-color);"></div>
                <div class="target-line" id="target0" title="Theoretical Limit"></div>
            </div>
        </div>

        <div class="stat-row">
            <div class="stat-header">
                <span id="statName1">State B</span>
                <span id="statPct1">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-bar" id="bar1" style="width: 0%; background: var(--state-b-color);"></div>
                <div class="target-line" id="target1" title="Theoretical Limit"></div>
            </div>
        </div>

        <div class="action-area">
            <button class="btn-step" onclick="manualStep()">+1 Step</button>
            <button class="btn-run" id="runBtn" onclick="toggleRun()">Run Fast</button>
            
            <div style="display:flex; flex-direction:column; align-items:center; margin-left: 10px;">
                <span style="font-size:0.6rem; font-weight:bold;">SPEED</span>
                <input type="range" id="speedRange" min="1" max="100" value="10">
            </div>
            
            <button class="btn-step" onclick="reset()">Reset</button>
            <button class="btn-step" onclick="toggleModal()">?</button>
        </div>
    </div>

    <div class="modal" id="infoModal">
        <div class="modal-content">
            <h2>Markov Chains & Sounds</h2>
            <p>This simulation creates a generated "soundscape" based on probability.</p>
            <ul>
                <li><strong>High Pitch:</strong> State A (e.g., Sunny)</li>
                <li><strong>Low Pitch:</strong> State B (e.g., Rainy)</li>
            </ul>
            <p><strong>Note:</strong> Sound automatically mutes if you crank the speed up to save your ears!</p>
            <button class="btn-run" onclick="toggleModal()">Got it</button>
        </div>
    </div>

    <script>
        // --- AUDIO SYSTEM (Web Audio API) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMuted = false;

        function playSound(type) {
            if (isMuted || audioCtx.state === 'suspended') return;
            
            // Auto-mute if speed is too high to prevent glitching
            const speed = parseInt(document.getElementById('speedRange').value);
            if (speed > 25) return; 

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // "Type" 0 = State A (High/Happy), "Type" 1 = State B (Low/Sad)
            if (type === 0) {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            } else {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
                osc.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.1);
            }

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('soundBtn').innerHTML = isMuted ? 'üîá' : 'üîä';
            document.getElementById('soundBtn').classList.toggle('muted');
            if(!isMuted && audioCtx.state === 'suspended') audioCtx.resume();
        }


        // --- CONFIG & STATE ---
        const presets = {
            weather: {
                colors: ["#f1c40f", "#3498db"],
                labels: ["Sunny", "Rainy"],
                icons: ["‚òÄÔ∏è", "üåßÔ∏è"],
                matrix: [[0.7, 0.3], [0.4, 0.6]], // [ [A->A, A->B], [B->A, B->B] ]
                target: [57.1, 42.9]
            },
            brand: {
                colors: ["#e74c3c", "#8e44ad"],
                labels: ["Brand A", "Brand B"],
                icons: ["üÖ∞Ô∏è", "üÖ±Ô∏è"],
                matrix: [[0.9, 0.1], [0.1, 0.9]],
                target: [50.0, 50.0]
            },
            habit: {
                colors: ["#2ecc71", "#7f8c8d"],
                labels: ["Healthy", "Habit"],
                icons: ["ü•ó", "üö¨"],
                matrix: [[0.5, 0.5], [0.1, 0.9]],
                target: [16.7, 83.3]
            },
            gamble: {
                colors: ["#27ae60", "#c0392b"],
                labels: ["Win", "Loss"],
                icons: ["ü§ë", "üí∏"],
                matrix: [[0.4, 0.6], [0.6, 0.4]],
                target: [50.0, 50.0]
            }
        };

        let currentPreset = presets.weather;
        let currentState = 0;
        let counts = [0, 0];
        let total = 0;
        let isRunning = false;
        let animationFrame;

        // --- DOM ELEMENTS ---
        const nodes = [document.getElementById('node0'), document.getElementById('node1')];
        const icons = [document.getElementById('icon0'), document.getElementById('icon1')];
        const labels = [document.getElementById('label0'), document.getElementById('label1')];
        const bars = [document.getElementById('bar0'), document.getElementById('bar1')];
        const targets = [document.getElementById('target0'), document.getElementById('target1')];
        const statPcts = [document.getElementById('statPct0'), document.getElementById('statPct1')];
        const statNames = [document.getElementById('statName0'), document.getElementById('statName1')];
        const particle = document.getElementById('particle');
        const ticker = document.getElementById('tickerTape');
        const paths = {
            '00': document.getElementById('pathAA'),
            '01': document.getElementById('pathAB'),
            '10': document.getElementById('pathBA'),
            '11': document.getElementById('pathBB')
        };

        // --- CORE LOGIC ---
        function loadPreset() {
            const key = document.getElementById('presetSelect').value;
            currentPreset = presets[key];

            // Update Colors CSS Variables
            document.documentElement.style.setProperty('--state-a-color', currentPreset.colors[0]);
            document.documentElement.style.setProperty('--state-b-color', currentPreset.colors[1]);
            document.documentElement.style.setProperty('--accent-color', currentPreset.colors[0]);

            // Update UI Text
            for(let i=0; i<2; i++) {
                icons[i].innerText = currentPreset.icons[i];
                labels[i].innerText = currentPreset.labels[i];
                statNames[i].innerText = currentPreset.labels[i];
                targets[i].style.left = currentPreset.target[i] + "%";
            }

            reset();
        }

        function reset() {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            document.getElementById('runBtn').classList.remove('running');
            document.getElementById('runBtn').innerText = "Run Fast";
            
            currentState = 0;
            counts = [0, 0];
            total = 0;
            ticker.innerHTML = '';
            
            updateVisuals(true);
        }

        function step() {
            // 1. Determine Next State
            const probs = currentPreset.matrix[currentState]; // [Stay, Switch] probability
            // probs[0] is P(stay), probs[1] is P(switch) if we assume matrix is standard
            // My matrix: [ [P(0->0), P(0->1)], [P(1->0), P(1->1)] ]
            // Actually let's use the row directly.
            
            const r = Math.random();
            let nextState;
            
            if (currentState === 0) {
                // Row 0: [P(0->0), P(0->1)]
                nextState = (r < currentPreset.matrix[0][0]) ? 0 : 1;
            } else {
                // Row 1: [P(1->0), P(1->1)] -- Note: index 0 is switching to 0
                nextState = (r < currentPreset.matrix[1][0]) ? 0 : 1;
            }

            // 2. Play Sound
            playSound(nextState);

            // 3. Highlight Path (only if slow enough to see)
            const speed = parseInt(document.getElementById('speedRange').value);
            if (speed < 50) {
                highlightPath(currentState, nextState);
            }

            // 4. Update State
            currentState = nextState;
            counts[currentState]++;
            total++;

            // 5. Update UI
            updateVisuals();
        }

        function highlightPath(from, to) {
            // Reset all paths
            document.querySelectorAll('path').forEach(p => p.classList.remove('active-path'));
            
            // Activate specific path
            const pathKey = "" + from + to;
            const path = paths[pathKey];
            if(path) {
                path.classList.add('active-path');
                setTimeout(() => path.classList.remove('active-path'), 200);
            }
        }

        function updateVisuals(isReset = false) {
            // Nodes active state
            nodes.forEach((n, i) => {
                if(i === currentState) n.classList.add('active');
                else n.classList.remove('active');
            });

            // Update Stats
            document.getElementById('stepCount').innerText = total.toLocaleString();
            
            if (total > 0) {
                const p0 = (counts[0] / total * 100).toFixed(1);
                const p1 = (counts[1] / total * 100).toFixed(1);
                
                bars[0].style.width = p0 + "%";
                statPct0.innerText = p0 + "%";
                
                bars[1].style.width = p1 + "%";
                statPct1.innerText = p1 + "%";
            } else {
                bars[0].style.width = "0%";
                bars[1].style.width = "0%";
                statPct0.innerText = "0%";
                statPct1.innerText = "0%";
            }

            // Update Ticker Tape (Only add if speed is manageable)
            const speed = parseInt(document.getElementById('speedRange').value);
            if (!isReset && speed < 80) {
                const span = document.createElement('span');
                span.className = 'ticker-item';
                span.innerText = currentPreset.icons[currentState];
                ticker.prepend(span);
                if (ticker.children.length > 20) ticker.lastChild.remove();
            }
        }

        // --- ANIMATION LOOP ---
        function toggleRun() {
            isRunning = !isRunning;
            const btn = document.getElementById('runBtn');
            if (isRunning) {
                btn.innerText = "Pause";
                btn.classList.add('running');
                if(audioCtx.state === 'suspended') audioCtx.resume();
                loop();
            } else {
                btn.innerText = "Run Fast";
                btn.classList.remove('running');
                cancelAnimationFrame(animationFrame);
            }
        }

        function manualStep() {
            if(isRunning) toggleRun(); // Stop auto if manual clicked
            if(audioCtx.state === 'suspended') audioCtx.resume();
            step();
        }

        function loop() {
            if (!isRunning) return;

            const speed = parseInt(document.getElementById('speedRange').value);
            
            // If speed is super high, do multiple calcs per frame
            let stepsPerFrame = 1;
            if (speed > 50) stepsPerFrame = Math.floor(Math.pow(speed - 40, 1.6));

            for (let i = 0; i < stepsPerFrame; i++) {
                step();
            }

            // Throttle visual updates if running very fast
            let delay = 0;
            if (speed < 30) delay = (30 - speed) * 20;

            if (delay > 0) {
                setTimeout(() => {
                    animationFrame = requestAnimationFrame(loop);
                }, delay);
            } else {
                animationFrame = requestAnimationFrame(loop);
            }
        }

        function toggleModal() {
            const m = document.getElementById('infoModal');
            m.classList.toggle('open');
        }

        // Init
        loadPreset();

    </script>
</body>
</html>
