<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birthday Paradox Sim</title>
    <link rel="icon" href="../favicon.ico">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --accent: #6c5ce7;
            --danger: #fab1a0;
            --match-color: #ff7675;
            --text-color: #2d3436;
            --gold: #fdcb6e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { margin-bottom: 5px; position: relative; z-index: 2; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        p.subtitle { color: #636e72; margin-top: 0; margin-bottom: 30px; position: relative; z-index: 2; }

        /* --- UPGRADED CANVAS --- */
        #webCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }

        /* --- CONTROLS --- */
        .controls {
            position: sticky; top: 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; gap: 15px;
            z-index: 100; margin-bottom: 30px;
            align-items: center; justify-content: center; flex-wrap: wrap;
            border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.2s;
        }

        button {
            background-color: var(--accent); color: white; border: none;
            padding: 12px 24px; border-radius: 25px; font-size: 1rem; cursor: pointer;
            transition: all 0.2s; font-weight: 700;
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4); }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background-color: #b2bec3; box-shadow: none; }
        
        button.secondary { background-color: #dfe6e9; color: var(--text-color); box-shadow: none; }
        button.delete { background-color: var(--danger); color: #d63031; box-shadow: none; }
        
        /* Sound Toggle */
        .icon-btn {
            background: transparent; color: #636e72; box-shadow: none; padding: 8px; 
            font-size: 1.2rem; width: auto; border: 1px solid transparent;
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); transform: none; }

        .stats {
            display: flex; flex-direction: column; text-align: center;
            min-width: 120px; padding: 0 10px;
            border-right: 1px solid rgba(0,0,0,0.1);
        }
        .stats:last-of-type { border-right: none; }
        .stats span { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #636e72; }
        .stats strong { font-size: 1.3rem; }

        /* --- ROOM & CARDS --- */
        .room {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            max-width: 1200px; position: relative; z-index: 1; padding-bottom: 100px;
        }

        .person-card {
            background: white; padding: 15px 10px; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center;
            width: 80px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .person-card .emoji { font-size: 2rem; margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .person-card .date { font-size: 0.9rem; font-weight: 700; color: #2d3436; }

        .person-card.match {
            border-color: var(--match-color);
            background-color: #fff0f0;
            transform: scale(1.15);
            z-index: 50;
            box-shadow: 0 0 30px var(--match-color);
            animation: pulseMatch 1s infinite;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-card {
            background: white; padding: 40px; border-radius: 24px;
            max-width: 500px; width: 90%; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        /* Win Specifics */
        #win-card { border: 4px solid var(--gold); }
        #win-emoji { font-size: 5rem; display: block; margin-bottom: 10px; animation: shake 0.5s infinite; }
        .highlight-stat { color: var(--accent); font-size: 1.5rem; font-weight: bold; }

        @keyframes popIn { from { opacity: 0; transform: scale(0); } to { opacity: 1; transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } }
        @keyframes pulseMatch { 0% { box-shadow: 0 0 20px var(--match-color); } 50% { box-shadow: 0 0 50px var(--match-color); } 100% { box-shadow: 0 0 20px var(--match-color); } }
    </style>
</head>
<body>

    <canvas id="webCanvas"></canvas>

    <h1>The Birthday Paradox</h1>
    <p class="subtitle">Math vs. Intuition</p>

    <div class="controls">
        <div class="stats">
            <span>People</span>
            <strong id="count">0</strong>
        </div>
        <div class="stats">
            <span>Comparisons</span>
            <strong id="pairs">0</strong>
        </div>
        <div class="stats">
            <span>Chance</span>
            <strong id="prob" style="color: var(--accent);">0%</strong>
        </div>
        
        <button id="addBtn" onclick="addPerson()">+ Add Person</button>
        <button id="delBtn" class="delete" onclick="removePerson()">Remove</button>
        <button class="secondary" onclick="resetSim()">Reset</button>
        
        <button class="icon-btn" onclick="toggleMute()" id="muteBtn" title="Toggle Sound">üîä</button>
        <button class="icon-btn" onclick="toggleInfo()">‚ÑπÔ∏è</button>
    </div>

    <div class="room" id="room"></div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal-card" style="text-align: left;">
            <h2 style="margin-top:0; color:var(--accent);">Why is this happening?</h2>
            <p>It feels like you need 183 people (50% of 365) to get a match, but that's wrong.</p>
            <p>You aren't comparing everyone to <em>you</em>. You are comparing <strong>everyone to everyone</strong>.</p>
            <div style="background:#f0f2f5; padding:15px; border-radius:10px; margin:15px 0;">
                <p style="margin:0; font-size:0.9rem;"><strong>The Formula:</strong><br>
                With 23 people, there are <strong>253</strong> lines connecting them.<br>
                With 50 people, there are <strong>1,225</strong> connections!</p>
            </div>
            <p>That spiderweb in the background? That represents the explosive growth of possible matching pairs.</p>
            <button onclick="toggleInfo()" style="width:100%;">Understood</button>
        </div>
    </div>

    <div class="modal-overlay" id="win-modal">
        <div class="modal-card" id="win-card">
            <span id="win-emoji">üèÜ</span>
            <h2 id="win-title">Match Found!</h2>
            <p id="win-text">You found a match.</p>
            <button onclick="toggleWin()" style="width:100%; background:var(--gold); color:black;">Awesome!</button>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMuted = false;

        function playSound(type) {
            if (isMuted || audioCtx.state === 'suspended') return;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'pop') {
                // Happy Bubble Pop
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400 + Math.random() * 200, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } 
            else if (type === 'delete') {
                // Quick slide down
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            }
            else if (type === 'match') {
                // Major Chord Arpeggio
                playNote(523.25, now, 0.1); // C5
                playNote(659.25, now + 0.05, 0.1); // E5
                playNote(783.99, now + 0.1, 0.2); // G5
                playNote(1046.50, now + 0.15, 0.4); // C6
            }
            else if (type === 'rare') {
                // Magical Arpeggio
                const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98];
                notes.forEach((freq, i) => playNote(freq, now + (i*0.06), 0.3));
            }
        }

        function playNote(freq, time, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + dur);
            osc.start(time);
            osc.stop(time + dur);
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? 'üîá' : 'üîä';
            if(!isMuted && audioCtx.state === 'suspended') audioCtx.resume();
        }

        // --- SIMULATION LOGIC ---
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const emojis = ['üòÉ', 'üòé', 'ü§ì', 'ü•≥', 'ü§†', 'ü§î', 'üò¥', 'üôÉ', 'üòØ', 'üßê', 'üëª', 'ü§ñ', 'üëΩ', 'ü¶ä'];
        
        let people = []; // Array of day numbers (1-365)
        let matchedIndices = []; // Stores indices of matching cards
        
        // --- VISUALIZATION LOOP ---
        const canvas = document.getElementById('webCanvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        
        // We use this to trigger the "New Person Scan" animation
        let latestPersonIndex = -1;
        let scanProgress = 0;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const cards = document.getElementsByClassName('person-card');
            if (cards.length < 2) {
                animationId = requestAnimationFrame(drawLoop);
                return;
            }

            // Get centers of all cards
            const points = [];
            for(let card of cards) {
                const rect = card.getBoundingClientRect();
                points.push({ x: rect.left + rect.width/2, y: rect.top + rect.height/2 });
            }

            // 1. Draw "Old" Connections (Static Web)
            // As more people are added, lines get fainter to avoid mess
            const baseOpacity = Math.max(0.02, 0.15 - (points.length * 0.003));
            ctx.lineWidth = 1;
            
            for (let i = 0; i < points.length; i++) {
                for (let j = i + 1; j < points.length; j++) {
                    
                    // IF there is a match, only draw the match line strongly
                    if (matchedIndices.length > 0) {
                        // Is this pair the match?
                        const isMatchPair = matchedIndices.includes(i) && matchedIndices.includes(j) && people[i] === people[j];
                        
                        if (isMatchPair) {
                            ctx.beginPath();
                            ctx.moveTo(points[i].x, points[i].y);
                            ctx.lineTo(points[j].x, points[j].y);
                            ctx.strokeStyle = `rgba(255, 118, 117, ${0.8 + Math.sin(Date.now()/100)*0.2})`; // Pulse Red
                            ctx.lineWidth = 4;
                            ctx.stroke();
                        } else {
                            // Draw others extremely faintly
                            ctx.beginPath();
                            ctx.moveTo(points[i].x, points[i].y);
                            ctx.lineTo(points[j].x, points[j].y);
                            ctx.strokeStyle = `rgba(108, 92, 231, 0.02)`; 
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    } 
                    else {
                        // Normal Web Drawing
                        ctx.beginPath();
                        ctx.moveTo(points[i].x, points[i].y);
                        ctx.lineTo(points[j].x, points[j].y);
                        ctx.strokeStyle = `rgba(108, 92, 231, ${baseOpacity})`;
                        ctx.stroke();
                    }
                }
            }

            // 2. Draw "New Person Scan" (The flashy lines when you click Add)
            if (latestPersonIndex !== -1 && latestPersonIndex < points.length) {
                const newP = points[latestPersonIndex];
                
                // Scan progress 0 to 1
                if (scanProgress < 1) {
                    scanProgress += 0.05; // Animation speed
                    
                    for(let i=0; i < latestPersonIndex; i++) {
                        const target = points[i];
                        
                        ctx.beginPath();
                        ctx.moveTo(newP.x, newP.y);
                        
                        // Lerp line
                        const currX = newP.x + (target.x - newP.x) * scanProgress;
                        const currY = newP.y + (target.y - newP.y) * scanProgress;
                        
                        ctx.lineTo(currX, currY);
                        ctx.strokeStyle = `rgba(108, 92, 231, 0.6)`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                } else {
                    // Animation done
                    latestPersonIndex = -1;
                }
            }

            animationId = requestAnimationFrame(drawLoop);
        }
        
        // Start Loop
        drawLoop();


        // --- LOGIC FUNCTIONS ---

        function getDateString(dayOfYear) {
            let day = dayOfYear;
            for (let i = 0; i < 12; i++) {
                let daysInMonth = (i === 1) ? 28 : ([3, 5, 8, 10].includes(i) ? 30 : 31);
                if (day <= daysInMonth) return `${months[i]} ${day}`;
                day -= daysInMonth;
            }
            return "Dec 31";
        }

        function updateStats() {
            const n = people.length;
            document.getElementById('count').innerText = n;
            
            // n * (n-1) / 2
            const pairs = (n * (n - 1)) / 2;
            document.getElementById('pairs').innerText = pairs;

            // Probability Math
            let noMatch = 1;
            for (let i = 0; i < n; i++) noMatch *= (365 - i) / 365;
            let prob = ((1 - noMatch) * 100).toFixed(2);
            document.getElementById('prob').innerText = prob + "%";
        }

        function checkMatches() {
            const counts = {};
            matchedIndices = [];
            let foundMatch = false;

            people.forEach((day, index) => {
                if (counts[day] !== undefined) {
                    // We found a collision!
                    matchedIndices.push(counts[day]); // The original person
                    matchedIndices.push(index);       // The new person
                    foundMatch = true;
                } else {
                    counts[day] = index;
                }
            });

            // UI Updates
            const cards = document.getElementsByClassName('person-card');
            for(let i=0; i<cards.length; i++) {
                if(matchedIndices.includes(i)) cards[i].classList.add('match');
                else cards[i].classList.remove('match');
            }

            return foundMatch;
        }

        function addPerson() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            playSound('pop');

            const dayNum = Math.floor(Math.random() * 365) + 1;
            people.push(dayNum);
            
            // Create DOM
            const card = document.createElement('div');
            card.className = 'person-card';
            card.innerHTML = `
                <span class="emoji">${emojis[Math.floor(Math.random() * emojis.length)]}</span>
                <span class="date">${getDateString(dayNum)}</span>
            `;
            document.getElementById('room').appendChild(card);

            // Trigger Animation
            latestPersonIndex = people.length - 1;
            scanProgress = 0;

            updateStats();

            // Check Win
            if (checkMatches()) {
                const btn = document.getElementById('addBtn');
                btn.innerText = "Match Found!";
                btn.disabled = true;
                
                const count = people.length;
                
                // Wait for the "Scan" animation to finish before showing popup
                setTimeout(() => {
                    const soundType = count <= 12 ? 'rare' : 'match';
                    playSound(soundType);
                    triggerWinPopup(count);
                }, 600);
            }
        }

        function removePerson() {
            if (people.length === 0) return;
            playSound('delete');
            people.pop();
            document.getElementById('room').lastElementChild.remove();
            
            matchedIndices = []; // Reset visual matches temporarily
            checkMatches(); // Re-check remaining
            updateStats();
            
            const btn = document.getElementById('addBtn');
            if (btn.disabled && matchedIndices.length === 0) {
                btn.disabled = false;
                btn.innerText = "+ Add Person";
            }
        }

        function resetSim() {
            people = [];
            matchedIndices = [];
            document.getElementById('room').innerHTML = '';
            updateStats();
            const btn = document.getElementById('addBtn');
            btn.disabled = false;
            btn.innerText = "+ Add Person";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- POPUPS ---
        function toggleInfo() { document.getElementById('info-modal').classList.toggle('active'); }
        function toggleWin() { document.getElementById('win-modal').classList.toggle('active'); }

        function triggerWinPopup(count) {
            const title = document.getElementById('win-title');
            const text = document.getElementById('win-text');
            const emoji = document.getElementById('win-emoji');

            if (count <= 12) {
                emoji.innerText = "ü¶Ñ";
                title.innerText = "IMPOSSIBLE!";
                text.innerHTML = `You found a match in only <span class="highlight-stat">${count}</span> people.<br>The odds of this are tiny!`;
            } else if (count < 23) {
                emoji.innerText = "üçÄ";
                title.innerText = "Lucky!";
                text.innerHTML = `Matched at <span class="highlight-stat">${count}</span>.<br>Beat the statistics (avg 23).`;
            } else {
                emoji.innerText = "üìä";
                title.innerText = "Statistics Win";
                text.innerHTML = `Matched at <span class="highlight-stat">${count}</span>.<br>Math works!`;
            }
            toggleWin();
        }

        // Close modal on outside click
        window.onclick = function(e) {
            if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('active');
        }
    </script>
</body>
</html>
